<!DOCTYPE html>
<html lang="en" class="h-full bg-blue-800">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agora - Browser Social Network</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Hide scrollbar for clean UI */
        ::-webkit-scrollbar {
            width: 0;
            background: transparent;
        }
        .view {
            display: none; /* All views hidden by default */
        }
        
        /* Classic 3D Button Style */
        .btn-3d {
            @apply border-2 border-t-gray-100 border-l-gray-100 border-b-black border-r-black active:border-t-black active:border-l-black active:border-b-gray-100 active:border-r-gray-100;
        }
        
        /* Classic 3D Inset Container Style */
        .container-3d {
             @apply bg-gray-300 shadow-md border-2 border-t-gray-100 border-l-gray-100 border-b-gray-500 border-r-gray-500;
        }

        /* Classic 3D Sunken Input Style */
        .input-3d {
            @apply border-2 border-gray-700 bg-white focus:outline-none focus:border-black;
        }

    </style>
</head>
<body class="h-full font-serif">
    <div id="app-root" class="flex flex-col h-screen">

        <!-- ===== Loading View ===== -->
        <div id="loading-view" class="view flex items-center justify-center h-full">
            <div class="text-center">
                <svg class="animate-spin h-12 w-12 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <h2 class="mt-4 text-xl font-semibold text-gray-700">Connecting to Agora...</h2>
            </div>
        </div>

        <!-- ===== Setup View (for new users) ===== -->
        <div id="setup-view" class="view flex items-center justify-center h-full p-4">
            <div class="bg-gray-300 p-8 shadow-xl w-full max-w-md text-center border-2 border-t-gray-100 border-l-gray-100 border-b-gray-500 border-r-gray-500">
                <h1 class="text-3xl font-bold text-blue-900 mb-4">Welcome to Agora</h1>
                <p class="text-gray-700 mb-6">Please set your public display name to join the conversation.</p>
                <form id="setup-form">
                    <input type="text" id="display-name-input" placeholder="Enter your display name" class="w-full px-4 py-3 border-2 border-gray-700 bg-white focus:outline-none focus:border-black" required>
                    <button type="submit" class="w-full bg-gray-300 text-black py-3 px-4 font-semibold mt-4 border-2 border-t-gray-100 border-l-gray-100 border-b-black border-r-black active:border-t-black active:border-l-black active:border-b-gray-100 active:border-r-gray-100">Save & Enter Agora</button>
                </form>
            </div>
        </div>

        <!-- ===== Main App Container (hidden until setup is complete) ===== -->
        <div id="app-container" class="view flex flex-col h-screen">
            <!-- Header -->
            <header id="user-info-header" class="bg-gray-300 shadow-md p-4 flex flex-col sm:flex-row justify-between items-center space-y-2 sm:space-y-0 border-b-2 border-gray-500">
                <h1 class="text-3xl font-bold text-blue-900">
                    <marquee behavior="scroll" direction="left" scrollamount="5">~*~ Agora ~*~</marquee>
                </h1>
                <div class="text-right">
                    <div id="user-display-name" class="font-semibold text-black"></div>
                    <div id="user-id" class="text-xs text-gray-700 break-all"></div>
                </div>
            </header>

            <!-- App Content Area -->
            <main class="flex-1 overflow-y-auto p-4 sm:p-6 bg-gray-200">
                
                <!-- ===== Rooms View (Homepage) ===== -->
                <div id="rooms-view" class="view max-w-4xl mx-auto">
                    <div class="flex flex-col md:flex-row justify-between md:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-semibold text-black">Rooms</h2>
                        <form id="create-room-form" class="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                            <input type="text" id="room-name-input" placeholder="New room name" class="px-3 py-2 border-2 border-gray-700 bg-white focus:outline-none focus:border-black flex-1" required>
                            <button type="submit" class="bg-gray-300 text-black py-2 px-4 font-semibold border-2 border-t-gray-100 border-l-gray-100 border-b-black border-r-black active:border-t-black active:border-l-black active:border-b-gray-100 active:border-r-gray-100">Create Room</button>
                        </form>
                    </div>
                    <div id="rooms-list" class="space-y-3">
                        <!-- Rooms will be injected here -->
                    </div>
                </div>

                <!-- ===== Posts View (Inside a Room) ===== -->
                <div id="posts-view" class="view max-w-4xl mx-auto">
                    <div class="mb-6">
                        <button id="back-to-rooms" class="text-blue-700 hover:underline mb-2">&larr; Back to all rooms</button>
                        <h2 id="posts-room-name" class="text-3xl font-bold text-black"></h2>
                    </div>
                    
                    <!-- Create Post Form -->
                    <div class="bg-gray-300 p-4 shadow-md mb-6 border-2 border-t-gray-100 border-l-gray-100 border-b-gray-500 border-r-gray-500">
                        <form id="create-post-form">
                            <h3 class="text-xl font-semibold mb-3">Create a new post</h3>
                            <input type="text" id="post-title-input" placeholder="Post title" class="w-full px-3 py-2 border-2 border-gray-700 bg-white focus:outline-none focus:border-black mb-2" required>
                            <textarea id="post-content-input" placeholder="What's on your mind? (optional)" rows="3" class="w-full px-3 py-2 border-2 border-gray-700 bg-white focus:outline-none focus:border-black mb-2"></textarea>
                            <button type="submit" class="bg-gray-300 text-black py-2 px-4 font-semibold border-2 border-t-gray-100 border-l-gray-100 border-b-black border-r-black active:border-t-black active:border-l-black active:border-b-gray-100 active:border-r-gray-100">Submit Post</button>
                        </form>
                    </div>

                    <!-- Posts List -->
                    <div id="posts-list" class="space-y-4">
                        <!-- Posts will be injected here -->
                    </div>
                </div>

                <!-- ===== Comments View (Inside a Post) ===== -->
                <div id="comments-view" class="view max-w-4xl mx-auto">
                    <div class="mb-6">
                        <button id="back-to-posts" class="text-blue-700 hover:underline mb-2">&larr; Back to room</button>
                    </div>
                    
                    <!-- Original Post -->
                    <div id="post-detail" class="bg-gray-300 p-5 shadow-md mb-6 border-2 border-t-gray-100 border-l-gray-100 border-b-gray-500 border-r-gray-500">
                        <!-- Post content injected here -->
                    </div>

                    <!-- Add Comment Form -->
                    <div class="bg-gray-300 p-4 shadow-md mb-6 border-2 border-t-gray-100 border-l-gray-100 border-b-gray-500 border-r-gray-500">
                        <form id="add-comment-form">
                            <h3 class="text-xl font-semibold mb-3">Add a comment</h3>
                            <textarea id="comment-content-input" placeholder="Join the discussion..." rows="3" class="w-full px-3 py-2 border-2 border-gray-700 bg-white focus:outline-none focus:border-black mb-2" required></textarea>
                            <button type="submit" class="bg-gray-300 text-black py-2 px-4 font-semibold border-2 border-t-gray-100 border-l-gray-100 border-b-black border-r-black active:border-t-black active:border-l-black active:border-b-gray-100 active:border-r-gray-100">Post Comment</button>
                        </form>
                    </div>

                    <!-- Comments List -->
                    <h3 class="text-2xl font-semibold text-gray-800 mb-4">Comments</h3>
                    <div id="comments-list" class="space-y-4">
                        <!-- Comments will be injected here -->
                    </div>
                </div>
            </main>
        </div>

    </div>

    <!-- Error Modal -->
    <div id="error-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-300 p-8 shadow-xl w-full max-w-md text-center border-4 border-double border-red-800">
            <h2 class="text-2xl font-bold text-red-800 mb-4">Error</h2>
            <p id="error-message" class="text-gray-800 mb-6"></p>
            <button id="close-error-modal" class="bg-gray-300 text-black py-2 px-6 font-semibold border-2 border-t-gray-100 border-l-gray-100 border-b-black border-r-black active:border-t-black active:border-l-black active:border-b-gray-100 active:border-r-gray-1s00">Close</button>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-300 p-8 shadow-xl w-full max-w-md text-center border-2 border-t-gray-100 border-l-gray-100 border-b-gray-500 border-r-gray-500">
            <h2 id="confirm-title" class="text-2xl font-bold text-black mb-4">Are you sure?</h2>
            <p id="confirm-message" class="text-gray-800 mb-6"></p>
            <div class="flex justify-center gap-4">
                <button id="cancel-delete-btn" class="bg-gray-300 text-black py-2 px-6 font-semibold border-2 border-t-gray-100 border-l-gray-100 border-b-black border-r-black active:border-t-black active:border-l-black active:border-b-gray-100 active:border-r-gray-100">Cancel</button>
                <button id="confirm-delete-btn" class="bg-red-600 text-white py-2 px-6 font-semibold border-2 border-t-red-400 border-l-red-400 border-b-red-800 border-r-red-800 active:border-t-red-800 active:border-l-red-800 active:border-b-red-400 active:border-r-red-400">Confirm</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // --- LOOK HERE! ---
        // Step 5 from instructions.md is just below this line.
        // ---

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            addDoc, 
            collection, 
            query, 
            where, 
            onSnapshot, 
            serverTimestamp,
            setLogLevel,
            getDocs,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Global State ---
        let db, auth;
        let currentUserId = null;
        let currentUserDisplayName = null;
        
        let currentRoomId = null;
        let currentRoomName = null;
        let currentPost = null;

        let roomsListener = null;
        let postsListener = null;
        let commentsListener = null;
        let confirmCallback = null;

        // --- This is your Firebase Config Object ---
        const firebaseConfig = {
            apiKey: "AIzaSyDlEr2MBDVoeErJhZCpSD8S3QT_StTJ0T0",
            authDomain: "my-agora-site.firebaseapp.com",
            projectId: "my-agora-site",
            storageBucket: "my-agora-site.firebasestorage.app",
            messagingSenderId: "340406321594",
            appId: "1:340406321594:web:8194c3df77c1d496669d83",
            measurementId: "G-E3VE85GQVL"
        };
        // --- END OF CONFIG ---

        // We use 'default-agora-app' as a public path.
        // You can leave this as-is.
        const appId = 'default-agora-app';
        
        // This is no longer needed when using your own project
        const initialAuthToken = null;

        // --- Firestore Collection References ---
        const USERS_COLLECTION = `artifacts/${appId}/public/data/agora-users`;
        const ROOMS_COLLECTION = `artifacts/${appId}/public/data/agora-rooms`;
        const POSTS_COLLECTION = `artifacts/${appId}/public/data/agora-posts`;
        const COMMENTS_COLLECTION = `artifacts/${appId}/public/data/agora-comments`;

        // --- UI Element References ---
        const views = {
            loading: document.getElementById('loading-view'),
            setup: document.getElementById('setup-view'),
            app: document.getElementById('app-container'),
            rooms: document.getElementById('rooms-view'),
            posts: document.getElementById('posts-view'),
            comments: document.getElementById('comments-view')
        };
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');

        // --- Utility Functions ---

        /**
         * Shows a specific view and hides all others.
         * @param {string} viewName - The key of the view to show (e.g., 'loading', 'setup', 'rooms')
         */
        function showView(viewName) {
            Object.keys(views).forEach(key => {
                if (key === viewName || (viewName !== 'loading' && viewName !== 'setup' && key === 'app')) {
                    // Show the main app container for 'rooms', 'posts', 'comments'
                    if (key === 'app') {
                        views[key].style.display = 'flex';
                    } else if (Object.keys(views).includes(viewName)) {
                         views[viewName].style.display = 'block';
                    }
                } else {
                    views[key].style.display = 'none';
                }
            });
            // Also hide all sub-views within the app container if we're not showing one of them
            if (viewName === 'loading' || viewName === 'setup') {
                views.rooms.style.display = 'none';
                views.posts.style.display = 'none';
                views.comments.style.display = 'none';
            }
        }

        /**
         * Displays the error modal with a specific message.
         * @param {string} message - The error message to display.
         */
        function showError(message) {
            console.error(message);
            errorMessage.textContent = message;
            errorModal.style.display = 'flex';
        }

        /**
         * Closes the error modal.
         */
        function closeErrorModal() {
            errorModal.style.display = 'none';
        }

        /**
         * Displays the confirmation modal with a specific message and callback.
         * @param {string} message - The confirmation message to display.
         * @param {function} callback - The function to execute if confirmed.
         */
        function showConfirmModal(message, callback) {
            const confirmModal = document.getElementById('confirm-modal');
            const confirmMessage = document.getElementById('confirm-message');
            confirmCallback = callback;
            confirmMessage.textContent = message;
            confirmModal.style.display = 'flex';
        }

        /**
         * Closes the confirmation modal.
         */
        function hideConfirmModal() {
            const confirmModal = document.getElementById('confirm-modal');
            confirmCallback = null;
            if (confirmModal) {
                confirmModal.style.display = 'none';
            }
        }


        /**
         * Formats Firestore timestamps into a readable string.
         * @param {object} timestamp - Firestore timestamp object.
         * @returns {string} - Formatted date/time string.
         */
        function formatTimestamp(timestamp) {
            if (!timestamp) return 'Just now';
            return timestamp.toDate().toLocaleString(undefined, {
                dateStyle: 'medium',
                timeStyle: 'short'
            });
        }

        /**
         * Detaches all active Firestore listeners.
         */
        function detachListeners() {
            if (roomsListener) roomsListener();
            if (postsListener) postsListener();
            if (commentsListener) commentsListener();
            roomsListener = postsListener = commentsListener = null;
        }

        // --- Navigation Functions ---

        /**
         * Navigates to the main Rooms view.
         */
        function navigateToRooms() {
            detachListeners();
            currentRoomId = null;
            currentRoomName = null;
            currentPost = null;
            listenToRooms();
            showView('rooms');
            window.scrollTo(0, 0);
        }

        /**
         * Navigates to the Posts view for a specific room.
         * @param {string} roomId - The document ID of the room.
         * @param {string} roomName - The name of the room.
         */
        function navigateToPosts(roomId, roomName) {
            detachListeners();
            currentRoomId = roomId;
            currentRoomName = roomName;
            currentPost = null;
            
            document.getElementById('posts-room-name').textContent = roomName;
            listenToPosts(roomId);
            showView('posts');
            window.scrollTo(0, 0);
        }

        /**
         * Navigates to the Comments view for a specific post.
         * @param {object} post - The post object.
         */
        function navigateToComments(post) {
            detachListeners();
            currentPost = post;
            
            // Render the post detail
            const postDetailEl = document.getElementById('post-detail');
            postDetailEl.innerHTML = `
                <h2 class="text-2xl font-bold text-gray-900 mb-2">${post.title}</h2>
                <p class="text-gray-700 whitespace-pre-wrap mb-3">${post.content}</p>
                <div class="text-sm text-gray-500">
                    Posted by <strong>${post.authorName || 'Anonymous'}</strong>
                </div>
                <div class="text-sm text-gray-500">${formatTimestamp(post.createdAt)}</div>
            `;
            
            document.getElementById('back-to-posts').onclick = () => navigateToPosts(currentRoomId, currentRoomName);
            
            listenToComments(post.id);
            showView('comments');
            window.scrollTo(0, 0);
        }

        // --- Firestore Listeners & Renderers ---

        /**
         * Listens for real-time updates to the rooms collection and renders them.
         */
        function listenToRooms() {
            const roomsListEl = document.getElementById('rooms-list');
            try {
                const q = query(collection(db, ROOMS_COLLECTION));
                roomsListener = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        roomsListEl.innerHTML = `<div class="text-center text-gray-500 py-10">No rooms yet. Be the first to create one!</div>`;
                        return;
                    }
                    
                    const rooms = [];
                    snapshot.forEach(doc => {
                        rooms.push({ id: doc.id, ...doc.data() });
                    });

                    // Sort rooms by name (A-Z)
                    rooms.sort((a, b) => a.name.localeCompare(b.name));

                    roomsListEl.innerHTML = rooms.map(room => {
                        // Show delete button only if the current user is the author
                        const deleteButtonHtml = room.createdBy === currentUserId ?
                            `<button class="delete-room-btn text-xs text-red-600 hover:underline float-right font-semibold" data-room-id="${room.id}">[Delete]</button>`
                            : '';
                        
                        // --- DEBUGGING INFO ---
                        const debugInfo = `
                            <div class="mt-2 text-xs text-gray-500 break-all">
                                <p>My ID: ${currentUserId}</p>
                                <p>Room Creator ID: ${room.createdBy || 'N/A'}</p>
                            </div>
                        `;
                        // --- END DEBUGGING ---
                        
                        return `
                        <div class="bg-gray-300 p-4 shadow-md border-2 border-t-gray-100 border-l-gray-100 border-b-gray-500 border-r-gray-500">
                            ${deleteButtonHtml}
                            <a href="#" class="block room-link" data-room-id="${room.id}" data-room-name="${room.name}">
                                <h3 class="text-xl font-semibold text-blue-800 hover:underline">${room.name}</h3>
                                <p class="text-sm text-gray-700">
                                    Created by <strong>${room.authorName || 'Anonymous'}</strong> on ${formatTimestamp(room.createdAt)}
                                </p>
                            </a>
                            ${debugInfo} <!-- Add the debug info here -->
                        </div>
                        `;
                    }).join('');

                }, (error) => {
                    showError("Failed to load rooms: " + error.message);
                    console.error("Error listening to rooms: ", error);
                });
            } catch (error) {
                showError("Error setting up rooms listener: " + error.message);
            }
        }

        /**
         * Listens for real-time updates to posts in a specific room.
         * @param {string} roomId - The ID of the room to fetch posts for.
         */
        function listenToPosts(roomId) {
            const postsListEl = document.getElementById('posts-list');
            postsListEl.innerHTML = `<div class="text-center text-gray-500 py-10">Loading posts...</div>`;
            try {
                const q = query(collection(db, POSTS_COLLECTION), where("roomId", "==", roomId));
                postsListener = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        postsListEl.innerHTML = `<div class="text-center text-gray-500 py-10">No posts in this room yet. Be the first!</div>`;
                        return;
                    }

                    const posts = [];
                    snapshot.forEach(doc => {
                        posts.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Sort posts by creation date (newest first)
                    posts.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));

                    postsListEl.innerHTML = posts.map(post => {
                        // Show delete button only if the current user is the author
                        const deleteButtonHtml = post.createdBy === currentUserId ?
                            `<button class="delete-post-btn text-xs text-red-600 hover:underline float-right font-semibold" data-post-id="${post.id}">[Delete]</button>`
                            : '';
                    
                        return `
                            <div class="bg-gray-300 p-4 shadow-md border-2 border-t-gray-100 border-l-gray-100 border-b-gray-500 border-r-gray-500">
                                ${deleteButtonHtml}
                                <a href="#" class="block post-link" data-post-id="${post.id}">
                                    <h3 class="text-xl font-semibold text-blue-800 hover:underline">${post.title}</h3>
                                    <p class="text-sm text-gray-700 truncate">${post.content || 'No content'}</p>
                                    <div class="text-xs text-gray-500 mt-2">
                                        Posted by <strong>${post.authorName || 'Anonymous'}</strong> &bull; ${formatTimestamp(post.createdAt)}
                                    </div>
                                </a>
                            </div>
                        `;
                    }).join('');
                    
                    // Store posts data on the element for the click handler
                    postsListEl.querySelectorAll('.post-link').forEach((el, index) => {
                        el.dataset.postObject = JSON.stringify(posts[index]);
                    });

                }, (error) => {
                    showError("Failed to load posts: " + error.message);
                    console.error("Error listening to posts: ", error);
                });
            } catch (error) {
                showError("Error setting up posts listener: " + error.message);
            }
        }
        
        /**
         * Listens for real-time updates to comments on a specific post.
         * @param {string} postId - The ID of the post to fetch comments for.
         !*/
        function listenToComments(postId) {
            const commentsListEl = document.getElementById('comments-list');
            commentsListEl.innerHTML = `<div class="text-center text-gray-500 py-10">Loading comments...</div>`;
            try {
                const q = query(collection(db, COMMENTS_COLLECTION), where("postId", "==", postId));
                commentsListener = onSnapshot(q, (snapshot) => {
                    if (snapshot.empty) {
                        commentsListEl.innerHTML = `<div class="text-center text-gray-500 py-10">No comments yet.</div>`;
                        return;
                    }

                    const comments = [];
                    snapshot.forEach(doc => {
                        comments.push({ id: doc.id, ...doc.data() });
                    });

                    // Sort comments by creation date (oldest first)
                    comments.sort((a, b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));

                    commentsListEl.innerHTML = comments.map(comment => `
                        <div class="bg-gray-300 p-4 shadow border-2 border-b-gray-500 border-r-gray-500 border-t-gray-100 border-l-gray-100">
                            <p class="text-gray-800 whitespace-pre-wrap">${comment.content}</p>
                            <div class="text-xs text-gray-600 mt-3 pt-2 border-t border-gray-400">
                                <strong>${comment.authorName || 'Anonymous'}</strong> &bull; ${formatTimestamp(comment.createdAt)}
                            </div>
                        </div>
                    `).join('');

                }, (error) => {
                    showError("Failed to load comments: " + error.message);
                    console.error("Error listening to comments: ", error);
                });
            } catch (error) {
                showError("Error setting up comments listener: " + error.message);
            }
        }


        // --- Event Handlers ---

        /**
         * Handles the new user setup form submission.
         */
        async function handleSetupSubmit(e) {
            e.preventDefault();
            const displayNameInput = document.getElementById('display-name-input');
            const displayName = displayNameInput.value.trim();
            
            if (!displayName) {
                showError("Display name cannot be empty.");
                return;
            }

            try {
                const userDocRef = doc(db, USERS_COLLECTION, currentUserId);
                await setDoc(userDocRef, {
                    displayName: displayName,
                    userId: currentUserId,
                    createdAt: serverTimestamp()
                });
                
                currentUserDisplayName = displayName;
                document.getElementById('user-display-name').textContent = currentUserDisplayName;
                document.getElementById('user-id').textContent = `ID: ${currentUserId}`;
                
                navigateToRooms();
                
            } catch (error) {
                showError("Failed to save display name: " + error.message);
                console.error("Error setting display name: ", error);
            }
        }

        /**
         * Handles the "Create Room" form submission.
         */
        async function handleCreateRoom(e) {
            e.preventDefault();
            const roomNameInput = document.getElementById('room-name-input');
            const roomName = roomNameInput.value.trim();

            if (!roomName) {
                showError("Room name cannot be empty.");
                return;
            }

            try {
                await addDoc(collection(db, ROOMS_COLLECTION), {
                    name: roomName,
                    createdBy: currentUserId,
                    authorName: currentUserDisplayName,
                    createdAt: serverTimestamp()
                });
                roomNameInput.value = ''; // Clear input
            } catch (error) {
                showError("Failed to create room: " + error.message);
                console.error("Error creating room: ", error);
            }
        }

        /**
         * Handles the "Create Post" form submission.
         */
        async function handleCreatePost(e) {
            e.preventDefault();
            const titleInput = document.getElementById('post-title-input');
            const contentInput = document.getElementById('post-content-input');
            
            const title = titleInput.value.trim();
            const content = contentInput.value.trim();

            if (!title) {
                showError("Post title cannot be empty.");
                return;
            }

            try {
                await addDoc(collection(db, POSTS_COLLECTION), {
                    roomId: currentRoomId,
                    title: title,
                    content: content,
                    createdBy: currentUserId,
                    authorName: currentUserDisplayName,
                    createdAt: serverTimestamp()
                });
                titleInput.value = '';
                contentInput.value = '';
            } catch (error) {
                showError("Failed to create post: " + error.message);
                console.error("Error creating post: ", error);
            }
        }

        /**
         * Handles the "Add Comment" form submission.
         */
        async function handleAddComment(e) {
            e.preventDefault();
            const contentInput = document.getElementById('comment-content-input');
            const content = contentInput.value.trim();

            if (!content) {
                showError("Comment cannot be empty.");
                return;
            }

            try {
                await addDoc(collection(db, COMMENTS_COLLECTION), {
                    postId: currentPost.id,
                    content: content,
                    createdBy: currentUserId,
                    authorName: currentUserDisplayName,
                    createdAt: serverTimestamp()
                });
                contentInput.value = '';
            } catch (error) {
                showError("Failed to add comment: " + error.message);
                console.error("Error adding comment: ", error);
            }
        }

        /**
         * Handles the click on the 'Confirm' button in the modal.
         */
        function handleConfirmDelete() {
            if (typeof confirmCallback === 'function') {
                confirmCallback();
            }
            hideConfirmModal();
        }

        /**
         * Deletes a post and all its associated comments.
         * @param {string} postId - The ID of the post to delete.
         */
        async function deletePost(postId) {
            if (!postId) return;
            
            try {
                // 1. Delete all comments associated with the post
                const q = query(collection(db, COMMENTS_COLLECTION), where("postId", "==", postId));
                const commentsSnapshot = await getDocs(q);
                
                const deletePromises = [];
                commentsSnapshot.forEach((doc) => {
                    deletePromises.push(deleteDoc(doc.ref));
                });
                await Promise.all(deletePromises);
                
                // 2. Delete the post itself
                const postDocRef = doc(db, POSTS_COLLECTION, postId);
                await deleteDoc(postDocRef);
                
                // If we are on the comments view of the deleted post, navigate back
                if (currentPost && currentPost.id === postId) {
                    navigateToPosts(currentRoomId, currentRoomName);
                }
                
            } catch (error) {
                showError("Failed to delete post: " + error.message);
                console.error("Error deleting post: ", error);
            }
        }

        /**
         * Deletes a room, all its posts, and all their comments.
         * @param {string} roomId - The ID of the room to delete.
         */
        async function deleteRoom(roomId) {
            if (!roomId) return;
            
            try {
                const deletePromises = [];
                
                // 1. Find all posts in the room
                const postsQuery = query(collection(db, POSTS_COLLECTION), where("roomId", "==", roomId));
                const postsSnapshot = await getDocs(postsQuery);

                // 2. For each post, find and queue its comments for deletion
                for (const postDoc of postsSnapshot.docs) {
                    const postId = postDoc.id;
                    const commentsQuery = query(collection(db, COMMENTS_COLLECTION), where("postId", "==", postId));
                    const commentsSnapshot = await getDocs(commentsQuery);
                    
                    commentsSnapshot.forEach((commentDoc) => {
                        deletePromises.push(deleteDoc(commentDoc.ref));
                    });
                    
                    // 3. Queue the post for deletion
                    deletePromises.push(deleteDoc(postDoc.ref));
                }
                
                // 4. Queue the room itself for deletion
                const roomDocRef = doc(db, ROOMS_COLLECTION, roomId);
                deletePromises.push(deleteDoc(roomDocRef));
                
                // 5. Run all deletions
                await Promise.all(deletePromises);
                
                // If we are in the deleted room, navigate back
                if (currentRoomId === roomId) {
                    navigateToRooms();
                }
                
            } catch (error) {
                showError("Failed to delete room: " + error.message);
                console.error("Error deleting room: ", error);
            }
        }


        /**
         * Handles clicks on dynamic elements (rooms, posts).
         */
        function handleDynamicClicks(e) {
            let target = e.target;
            
            // Navigate to Posts
            const roomLink = target.closest('.room-link');
            if (roomLink) {
                e.preventDefault();
                const roomId = roomLink.dataset.roomId;
                const roomName = roomLink.dataset.roomName;
                navigateToPosts(roomId, roomName);
                return;
            }

            // Navigate to Comments
            const postLink = target.closest('.post-link');
            if (postLink) {
                e.preventDefault();
                try {
                    const post = JSON.parse(postLink.dataset.postObject);
                    // Re-parse the timestamp if it's a string
                    if (post.createdAt && typeof post.createdAt === 'object') {
                        post.createdAt = {
                            ...post.createdAt,
                            toDate: () => new Date(post.createdAt.seconds * 1000)
                        };
                    }
                    navigateToComments(post);
                } catch (err) {
                    showError("Could not load post details.");
                    console.error("Error parsing post object:", err);
                }
                return;
            }

            // Handle Delete Post
            const deletePostBtn = target.closest('.delete-post-btn');
            if (deletePostBtn) {
                e.preventDefault();
                e.stopPropagation(); // Stop it from triggering the post link click
                const postId = deletePostBtn.dataset.postId;
                
                // Show confirmation
                showConfirmModal("Are you sure you want to delete this post? This will also delete all comments.", () => {
                    deletePost(postId);
                });
                return;
            }

            // Handle Delete Room
            const deleteRoomBtn = target.closest('.delete-room-btn');
            if (deleteRoomBtn) {
                e.preventDefault();
                e.stopPropagation(); // Stop it from triggering the room link click
                const roomId = deleteRoomBtn.dataset.roomId;
                
                // Show confirmation
                showConfirmModal("Are you sure you want to delete this room? This will delete ALL posts and comments inside it.", () => {
                    deleteRoom(roomId);
                });
                return;
            }
        }

        // --- App Initialization ---

        /**
         * Main initialization function.
         */
        async function initApp() {
            showView('loading');
            
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR_API_KEY")) {
                showError("Firebase configuration is missing or is still the placeholder. Please follow the instructions to set up your own Firebase project and paste the config object into agora.html.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug'); // Enable Firestore logging

                // Attach global event listeners
                document.getElementById('setup-form').addEventListener('submit', handleSetupSubmit);
                document.getElementById('create-room-form').addEventListener('submit', handleCreateRoom);
                document.getElementById('create-post-form').addEventListener('submit', handleCreatePost);
                document.getElementById('add-comment-form').addEventListener('submit', handleAddComment);
                document.getElementById('close-error-modal').addEventListener('click', closeErrorModal);
                document.getElementById('back-to-rooms').addEventListener('click', navigateToRooms);
                
                // Add listeners for the new confirm modal
                document.getElementById('cancel-delete-btn').addEventListener('click', hideConfirmModal);
                document.getElementById('confirm-delete-btn').addEventListener('click', handleConfirmDelete);

                // Use event delegation for dynamic content
                document.getElementById('app-root').addEventListener('click', handleDynamicClicks);

                // Start auth process
                handleAuth();

            } catch (error) {
                showError("Failed to initialize app: " + error.message);
                console.error("Initialization error: ", error);
            }
        }

        /**
         * Handles user authentication and setup check.
         */
        function handleAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    console.log("Current User ID:", currentUserId); // <-- Add this log
                    
                    // Check if user has a profile
                    const userDocRef = doc(db, USERS_COLLECTION, currentUserId);
                    const userDoc = await getDoc(userDocRef);

                    if (userDoc.exists()) {
                        currentUserDisplayName = userDoc.data().displayName;
                        document.getElementById('user-display-name').textContent = currentUserDisplayName;
                        document.getElementById('user-id').textContent = `ID: ${currentUserId}`;
                        navigateToRooms();
                    } else {
                        // New user, show setup view
                        showView('setup');
                    }
                } else {
                    // No user, sign them in
                    try {
                        // We will always sign in anonymously for this public app
                        await signInAnonymously(auth);
                        // onAuthStateChanged will fire again with the new user
                    } catch (error) {
                        showError("Authentication failed: " + error.message);
                        console.error("Error during sign-in: ", error);
                    }
                }
            });
        }

        // Start the app
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
