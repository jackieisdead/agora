<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agora :: Your Open Social Space</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pixelify+Sans:wght@400..700&family=VT323&display=swap" rel="stylesheet">

    <style>
        /* CSS is mostly the same, with new styles for the Modal */
        body {
            background: #f0f0f0 url(https://www.transparenttextures.com/patterns/stardust.png);
            font-family: 'VT323', monospace;
            font-size: 18px;
            line-height: 1.6;
            color: #333;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            background: #ffffff;
            border: 2px solid #000;
            box-shadow: 6px 6px 0px #999;
            padding: 10px;
        }

        .header {
            text-align: center;
            padding: 20px;
            border-bottom: 4px double #000;
        }

        .header h1 {
            font-family: 'Pixelify Sans', sans-serif;
            font-size: 4.5em;
            margin: 0;
            color: #000;
            text-shadow: 3px 3px #ccc;
        }

        .header p {
            font-size: 1.2em;
            margin: 0;
            font-weight: bold;
        }

        .navbar {
            text-align: center;
            padding: 10px 0;
            border-bottom: 2px solid #eee;
        }

        .navbar a {
            font-family: 'Pixelify Sans', sans-serif;
            font-size: 1.3em;
            text-decoration: none;
            color: #0000ee;
            margin: 0 15px;
            padding: 2px 5px;
            transition: all 0.2s;
        }

        .navbar a:hover {
            background: #ffff99;
            text-decoration: underline;
        }

        .main-layout {
            display: flex;
            flex-wrap: wrap;
            padding-top: 20px;
        }

        .content {
            flex: 3;
            padding-right: 20px;
            min-width: 300px;
        }

        .sidebar {
            flex: 1;
            padding-left: 20px;
            border-left: 2px dashed #ccc;
            min-width: 200px;
        }

        h2 {
            font-family: 'Pixelify Sans', sans-serif;
            font-size: 2.5em;
            color: #000;
            border-bottom: 2px solid #000;
            padding-bottom: 5px;
        }
        
        h3 {
            font-family: 'Pixelify Sans', sans-serif;
            font-size: 1.8em;
            color: #333;
        }

        .button {
            display: inline-block;
            background: #ddd;
            border: 2px outset #aaa;
            padding: 8px 15px;
            text-decoration: none;
            color: #000;
            font-family: 'Pixelify Sans', sans-serif;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .button:hover {
            background: #ccc;
        }

        .button:active {
            border-style: inset;
            background: #bbb;
        }
        
        /* Smaller button for the feed */
        .button-small {
            background: #eee;
            border: 2px outset #ccc;
            padding: 2px 8px;
            text-decoration: none;
            color: #333;
            font-family: 'VT323', monospace;
            font-size: 1em;
            cursor: pointer;
            margin-left: 8px;
        }
        .button-small:hover {
            background: #ddd;
        }
        .button-small:active {
            border-style: inset;
        }

        /* NEW: Button for favoriting */
        .button-fav {
            background: #fff;
            border: 2px outset #ccc;
            color: #daa520; /* Goldenrod color for star */
            font-size: 1.1em;
            padding: 2px 6px;
            margin-left: 4px;
        }
        .button-fav:hover {
            background: #f0f0f0;
        }
        .button-fav:disabled {
            color: #999;
            background: #f9f9f9;
            cursor: not-allowed;
        }
        
        /* NEW: Button for removing favorite */
        .button-remove-fav {
            background: #fee;
            border: 2px outset #ccc;
            color: #d00;
            font-family: 'VT323', monospace;
            font-size: 0.9em;
            cursor: pointer;
            margin-left: 8px;
        }
        .button-remove-fav:hover {
            background: #fdd;
        }


        .feature-box {
            background: #f9f9f9;
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 15px;
        }

        .sidebar-box {
            border: 2px solid #eee;
            background: #fafafa;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .sidebar-box h3 {
            margin-top: 0;
            border-bottom: 1px solid #ccc;
        }
        
        .sidebar-box p {
            font-size: 0.9em;
            margin: 0 0 10px 0;
        }

        /* NEW: Auth status box */
        #auth-status {
            background: #ffc;
            border: 2px dashed #cc9;
            font-size: 1em;
            padding: 10px;
            word-break: break-all;
        }
        #auth-status p {
            margin: 0;
            font-weight: bold;
        }

        .sidebar-gif {
            width: 100%;
            height: auto;
            image-rendering: pixelated;
        }

        #server-search {
            width: 100%;
            box-sizing: border-box;
            font-family: 'VT323', monospace;
            font-size: 16px;
            padding: 5px;
            border: 2px inset #aaa;
            background: #fff;
            margin-bottom: 10px;
        }
        
        .server-list-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ccc;
            background: #fff;
            padding: 5px;
        }

        #server-list, #favorite-server-list {
            list-style-type: none;
            padding-left: 0;
            margin: 0;
        }
        
        .server-list-item {
            border-bottom: 1px dashed #eee;
            padding: 8px 5px;
        }
        
        .server-list-item:last-child {
            border-bottom: none;
        }

        .server-list-item a {
            font-family: 'Pixelify Sans', sans-serif;
            font-size: 1.2em;
            color: #0000ee;
            text-decoration: none;
            font-weight: bold;
            word-break: break-all;
        }
        
        .server-list-item a:hover {
            text-decoration: underline;
        }

        .server-list-item p {
            font-size: 1em;
            color: #333;
            margin: 3px 0 0 0;
            line-height: 1.3;
        }
        
        .server-list-item span {
            font-size: 0.9em;
            color: #008000;
            font-weight: bold;
            display: block;
            margin-top: 4px;
        }

        /* NEW: Favorite list styles */
        #favorite-server-list .server-list-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        #favorite-server-list .server-info {
            flex-grow: 1;
        }


        .footer {
            text-align: center;
            border-top: 4px double #000;
            padding: 20px;
            margin-top: 20px;
            font-size: 1.1em;
        }

        /* --- NEW MODAL STYLES --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6); /* Black overlay */
        }

        .modal-content {
            position: relative;
            background: #fff;
            border: 2px solid #000;
            box-shadow: 6px 6px 0px #999;
            margin: 10% auto;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            font-size: 16px; /* Use smaller font for modal */
        }
        
        .modal-header {
            border-bottom: 2px dashed #ccc;
            padding-bottom: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
            word-break: break-all;
        }

        .modal-close {
            font-family: 'Pixelify Sans', sans-serif;
            font-size: 2em;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            padding: 0 10px;
        }

        .modal-close:hover {
            color: #000;
        }
        
        .modal-body {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .post {
            border: 1px solid #eee;
            background: #fcfcfc;
            padding: 10px;
            margin-bottom: 10px;
        }
        
        .post-author {
            font-weight: bold;
            font-family: 'Pixelify Sans', sans-serif;
            font-size: 1.2em;
            color: #000;
            margin-bottom: 5px;
        }
        
        .post-content {
            font-size: 1em;
            line-height: 1.5;
            word-wrap: break-word; /* Handle long strings */
        }
        /* Style paragraphs inside the post content */
        .post-content p {
            margin: 0 0 10px 0;
        }
        .post-content p:last-child {
            margin-bottom: 0;
        }

    </style>
</head>
<body>

    <div class="container">

        <header class="header">
            <h1>AGORA</h1>
            <p>The Open Public Square</p>
        </header>

        <nav class="navbar">
            <a href="#about">About</a>
            <a href="#features">Features</a>
            <a href="#servers">Get Started</a>
            <a href="https://instances.social/" target="_blank">Source Code</a>
        </nav>

        <div class="main-layout">

            <!-- Left Column: Content -->
            <main class="content">
                <section id="about">
                    <h2>Welcome to the conversation.</h2>
                    <p>
                        Tired of giant websites tracking you and controlling your feed?
                        Agora is different. It's not one single site, but a network of thousands
                        of independent communities that can all talk to each other.
                    </p>
                    <p>
                        This page is a real portal. The list on the right is a
                        <strong>live feed</strong> of actual <strong>Fediverse</strong> servers you can join.
                        Click "View Feed" to see what's happening on a server right now, or
                        <strong>'☆' to save it to your favorites!</strong>
                    </p>
                    <a href="#servers" class="button">Browse Servers &rarr;</a>
                </section>

                <section id="features">
                    <h2>How It Works</h2>

                    <div class="feature-box">
                        <h3>[ 1 ] Choose Your Community</h3>
                        <p>
                            Use the list on the right to find a server.
                            Click "View Feed" to sample the public conversation, or '☆'
                            to add it to your "My Favorites" list.
                        </p>
                    </div>

                    <div class="feature-box">
                        <h3>[ 2 ] Create Your Profile</h3>
                        <p>
                            Like what you see? Click the server's name to visit their
                            homepage and sign up (for free!).
                        </p>
                    </div>

                    <div class="feature-box">
                        <h3>[ 3 ] Connect with Anyone</h3>
                        <p>
                            From your new account, you can follow friends and interesting
                            people from *any* other Fediverse server.
                        </p>
                    </div>
                </section>

            </main>

            <!-- Right Column: Sidebar -->
            <aside class="sidebar">
                
                <img src="https://web.archive.org/web/20090830084344if_/http://geocities.com/athens/olympus/1350/globe.gif" 
                     alt="Spinning pixel globe" 
                     class="sidebar-gif"
                     onerror="this.style.display='none'">

                <!-- NEW: Auth Status -->
                <div class="sidebar-box" id="auth-status">
                    <p>Connecting...</p>
                </div>

                <!-- NEW: Favorite Servers Box -->
                <div class="sidebar-box" id="favorite-servers-box">
                    <h3>My Favorite Servers</h3>
                    <div class="server-list-container">
                        <ul id="favorite-server-list">
                            <li>Loading favorites...</li>
                        </ul>
                    </div>
                </div>


                <!-- FUNCTIONAL SERVER BROWSER -->
                <div class="sidebar-box" id="servers">
                    <!-- UPDATED TEXT -->
                    <h3>Find a Fediverse Server</h3>
                    <p>Live list of (English-speaking) servers.
                       Search by name or description.
                    </V>
                    <input type="text" id="server-search" placeholder="Filter Fediverse servers...">
                    
                    <div class="server-list-container">
                        <ul id="server-list">
                            <li>Loading servers...</li>
                        </ul>
                    </div>
                </div>
                <!-- END FUNCTIONAL SERVER BROWSER -->

                <div class="sidebar-box">
                    <h3>Badges</h3>
                    <img src="https://web.archive.org/web/20091027173153if_/http://geocities.com/clipart/pbi/buttons/Mozilla/mozilla_1.gif" alt="Powered by Mozilla" style="margin: 2px;" onerror="this.style.display='none'">
                    <img src="https://web.archive.org/web/20091027173153if_/http://geocities.com/clipart/pbi/buttons/Computer/webnow.gif" alt="Viewable on any browser" style="margin: 2px;" onerror="this.style.display='none'">
                    <img src="https://web.archive.org/web/20091026194354if_/http://www.geocities.com/Area51/Rampart/2627/anarchy.gif" alt="Anarchy" style="margin: 2px;" onerror="this.style.display='none'">
                </div>

            </aside>

        </div>

        <footer class="footer">
            <p>Built by the community.</p>
            <p>This is a functional portal to the Fediverse. Server list
                powered by the <a href="https://instances.social/api/1.0/" target="_blank">instances.social API</a>
                via <a href="https://allorigins.win/" target="_blank">allorigins.win</a>.
            </p>
        </footer>

    </div>
    
    <!-- NEW: The Modal (Popup) HTML (Unchanged) -->
    <div id="feed-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Loading feed...</h3>
                <span id="modal-close" class="modal-close">&times;</span>
            </div>
            <div id="modal-body" class="modal-body">
                <p>Fetching public posts...</p>
            </div>
        </div>
    </div>


    <!-- NEW: Import Firebase services -->
    <script type="module">
        // These global variables are provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "DEFAULT_API_KEY", authDomain: "DEFAULT_AUTH_DOMAIN", projectId: "DEFAULT_PROJECT_ID" };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Import functions from the Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            updateDoc, 
            arrayUnion, 
            arrayRemove,
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Enable debug logging for Firestore
        setLogLevel('Debug');

        // --- Main App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const serverList = document.getElementById('server-list');
            const serverSearch = document.getElementById('server-search');
            const favoriteServerList = document.getElementById('favorite-server-list');
            const authStatus = document.getElementById('auth-status');
            
            // Modal elements
            const modal = document.getElementById('feed-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalBody = document.getElementById('modal-body');
            const modalClose = document.getElementById('modal-close');
            
            const API_URL = 'https://instances.social/api/1.0/instances/list?count=100&min_users=20&sort_by=users&sort_order=desc&include_down=false&include_closed=false&language=en';
            const PROXY_URL = 'https://api.allorigins.win/raw?url=';
            const FETCH_URL = PROXY_URL + encodeURIComponent(API_URL);
            
            let allServers = []; // Cached list of all servers from API
            let currentFavorites = []; // Cached list of user's favorites
            let userId = null;
            let userDocRef = null;
            let unsubscribeFavorites = () => {}; // Function to detach listener

            // --- Authentication ---
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    console.log("User is signed in:", user.uid);
                    userId = user.uid;
                    
                    // **** FIX: Added '/data' to the end of the path ****
                    // This creates a 6-segment path pointing to a document,
                    // rather than a 5-segment path pointing to a collection.
                    userDocRef = doc(db, `artifacts/${appId}/users/${userId}/fediversePortal/data`);
                    
                    authStatus.innerHTML = `<p>Your User ID:<br>${userId}</p>`;
                    
                    // Detach any old listener
                    unsubscribeFavorites(); 
                    
                    // Set up listener for this user's favorites
                    setupFavoritesListener();
                    
                    // Fetch servers (we only do this once auth is ready)
                    await fetchServers();

                } else {
                    console.log("User is signed out. Attempting to sign in...");
                    authStatus.innerHTML = `<p>Connecting...</p>`;
                    userId = null;
                    userDocRef = null;
                    unsubscribeFavorites(); // Detach listener
                    
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error signing in:", error);
                        authStatus.innerHTML = `<p>Connection failed. Please refresh.</p>`;
                    }
                }
            });

            // --- Firestore Favorites Listener ---
            function setupFavoritesListener() {
                if (!userDocRef) return;

                unsubscribeFavorites = onSnapshot(userDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        currentFavorites = docSnap.data().favorites || [];
                        console.log("Favorites updated:", currentFavorites);
                    } else {
                        // No document yet, favorites list is empty
                        currentFavorites = [];
                        console.log("No favorites document found.");
                    }
                    renderFavorites(currentFavorites);
                    // After favorites are loaded/updated, re-render the main server list
                    // to update the "Favorite" button states
                    renderServers(allServers);
                }, (error) => {
                    console.error("Error listening to favorites:", error);
                    favoriteServerList.innerHTML = '<li>Error loading favorites.</li>';
                });
            }

            // --- NEW: Render Favorites List ---
            function renderFavorites(favorites) {
                favoriteServerList.innerHTML = '';
                if (favorites.length === 0) {
                    favoriteServerList.innerHTML = '<li>No favorites yet. Click ☆ to add one!</li>';
                    return;
                }

                favorites.forEach(server => {
                    const li = document.createElement('li');
                    li.className = 'server-list-item';

                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'server-info';

                    const link = document.createElement('a');
                    link.href = `https://` + server.name;
                    link.textContent = server.name;
                    link.target = '_blank';

                    const description = document.createElement('p');
                    description.textContent = server.description;
                    
                    infoDiv.appendChild(link);
                    infoDiv.appendChild(description);
                    
                    const removeButton = document.createElement('button');
                    removeButton.className = 'button-remove-fav';
                    removeButton.textContent = 'Remove';
                    removeButton.onclick = () => removeFavorite(server); // Pass the exact object to remove

                    li.appendChild(infoDiv);
                    li.appendChild(removeButton);
                    favoriteServerList.appendChild(li);
                });
            }

            // --- NEW: Add/Remove Favorite Functions ---
            async function addFavorite(serverName, serverDescription) {
                if (!userDocRef) return;
                const serverData = { name: serverName, description: serverDescription || "No description." };
                try {
                    await setDoc(userDocRef, { 
                        favorites: arrayUnion(serverData) 
                    }, { merge: true }); // Use set with merge to create doc if it doesn't exist
                    console.log("Added favorite:", serverName);
                } catch (error) {
                    console.error("Error adding favorite:", error);
                }
            }

            async function removeFavorite(serverObject) {
                if (!userDocRef) return;
                try {
                    await updateDoc(userDocRef, {
                        favorites: arrayRemove(serverObject)
                    });
                    console.log("Removed favorite:", serverObject.name);
                } catch (error) {
                    console.error("Error removing favorite:", error);
                }
            }


            // --- Function to safely sanitize HTML content ---
            function sanitizeHTML(html) {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                doc.querySelectorAll('script, style').forEach(el => el.remove());
                doc.querySelectorAll('*').forEach(el => {
                    for (let i = 0; i < el.attributes.length; i++) {
                        const attrName = el.attributes[i].name;
                        if (attrName.startsWith('on')) {
                            el.removeAttribute(attrName);
                        }
                    }
                });
                return doc.body.innerHTML;
            }

            // --- Function to show the modal and fetch the public feed ---
            async function showPublicFeed(domain) {
                modal.style.display = 'block';
                modalTitle.textContent = `Public Feed: ${domain}`;
                modalBody.innerHTML = '<p>Fetching public posts...</p>';
                
                const publicFeedUrl = `https://${domain}/api/v1/timelines/public?limit=10`;
                const proxiedFeedUrl = PROXY_URL + encodeURIComponent(publicFeedUrl);

                try {
                    const response = await fetch(proxiedFeedUrl);
                    if (!response.ok) {
                        throw new Error(`Server returned status ${response.status}`);
                    }
                    const dataText = await response.text();
                    
                    // Handle potential non-JSON responses from the proxy on error
                    let feedData;
                    try {
                        feedData = JSON.parse(dataText);
                    } catch (jsonError) {
                         throw new Error(`Failed to parse response from server. It might be down or blocking requests.`);
                    }


                    if (!feedData || feedData.length === 0) {
                        modalBody.innerHTML = '<p>No public posts found.</p>';
                        return;
                    }
                    
                    // Clear loading message
                    modalBody.innerHTML = '';
                    
                    // Render each post
                    feedData.forEach(post => {
                        const postDiv = document.createElement('div');
                        postDiv.className = 'post';
                        
                        const author = document.createElement('div');
                        author.className = 'post-author';
                        author.textContent = post.account.display_name || post.account.username;
                        
                        const content = document.createElement('div');
                        content.className = 'post-content';
                        // Sanitize and set the post's HTML content
                        content.innerHTML = sanitizeHTML(post.content);
                        
                        postDiv.appendChild(author);
                        postDiv.appendChild(content);
                        modalBody.appendChild(postDiv);
                    });

                } catch (error) {
                    modalBody.innerHTML = `<p><strong>Error loading feed:</strong> ${error.message}</p>`;
                    console.error('Error fetching public feed:', error);
                }
            }
            
            // --- Event listeners to close the modal ---
            modalClose.onclick = () => {
                modal.style.display = 'none';
            };
            
            // Close if user clicks outside the modal content
            window.onclick = (event) => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            };


            // --- MODIFIED: renderServers function ---
            function renderServers(serversToRender) {
                serverList.innerHTML = ''; 
                
                if (serversToRender.length === 0 && allServers.length > 0) {
                    serverList.innerHTML = '<li>No matching servers found.</li>';
                    return;
                }
                if (allServers.length === 0) {
                     serverList.innerHTML = '<li>Loading servers...</li>';
                    return;
                }

                // Get a list of favorite names for easy checking
                const favoriteNames = currentFavorites.map(f => f.name);

                serversToRender.forEach(server => {
                    if (!server.info) {
                        return;
                    }

                    const li = document.createElement('li');
                    li.className = 'server-list-item';

                    // 1. The Server Link
                    const link = document.createElement('a');
                    link.href = `https://` + server.name;
                    link.textContent = server.name;
                    link.target = '_blank';
                    
                    // 2. The "View Feed" Button
                    const feedButton = document.createElement('button');
                    feedButton.className = 'button-small';
                    feedButton.textContent = 'View Feed';
                    feedButton.onclick = () => {
                        showPublicFeed(server.name);
                    };

                    // 3. NEW: The "Favorite" Button
                    const favButton = document.createElement('button');
                    favButton.className = 'button-small button-fav';
                    
                    const isFavorited = favoriteNames.includes(server.name);
                    
                    if (isFavorited) {
                        favButton.textContent = '★'; // Solid star
                        favButton.title = 'Already in favorites';
                        favButton.disabled = true;
                    } else {
                        favButton.textContent = '☆'; // Outline star
                        favButton.title = 'Add to favorites';
                        favButton.disabled = false;
                        favButton.onclick = () => {
                            const description = server.info?.short_description || 'No description.';
                            addFavorite(server.name, description);
                        };
                    }


                    const description = document.createElement('p');
                    description.textContent = server.info?.short_description || 'No description available.';
                    
                    const stats = document.createElement('span');
                    stats.textContent = `${server.users} users`;
                    
                    li.appendChild(link);
                    li.appendChild(feedButton); // Add the feed button
                    li.appendChild(favButton); // Add the favorite button
                    li.appendChild(description);
                    li.appendChild(stats);
                    
                    serverList.appendChild(li);
                });
            }

            // --- fetchServers function (mostly unchanged) ---
            async function fetchServers() {
                try {
                    const response = await fetch(FETCH_URL);
                    if (!response.ok) {
                        throw new Error(`Proxy or API server returned status ${response.status}`);
                    }
                    const dataText = await response.text();
                    const data = JSON.parse(dataText);
                    
                    const allInstances = data.instances || []; 

                    allServers = allInstances.filter(server => server.info); // Just make sure it has an info object
                    
                    if (allServers.length > 0) {
                        // Pass the current list of servers to be rendered
                        const searchTerm = serverSearch.value.toLowerCase();
                        if (searchTerm) {
                            filterAndRenderServers(searchTerm);
                        } else {
                            renderServers(allServers);
                        }
                    } else {
                        serverList.innerHTML = '<li>No open servers found at this time.</li>';
                    }

                } catch (error) {
                    console.error('Error fetching server list:', error);
                    serverList.innerHTML = `<li><strong>Error loading servers:</strong><br>${error.message}.<br>Please try again later.</li>`;
                }
            }

            // --- NEW: Helper function to filter and render
            function filterAndRenderServers(searchTerm) {
                const filteredServers = allServers.filter(server => {
                    const domainMatch = server.name.toLowerCase().includes(searchTerm);
                    const descriptionMatch = (server.info?.short_description || '').toLowerCase().includes(searchTerm);
                    return domainMatch || descriptionMatch;
                });
                renderServers(filteredServers);
            }

            // --- Search event listener ---
            serverSearch.addEventListener('keyup', () => {
                const searchTerm = serverSearch.value.toLowerCase();
                filterAndRenderServers(searchTerm);
            });

            // Initial auth check triggers everything else
        });
    </script>

</body>
</html>
